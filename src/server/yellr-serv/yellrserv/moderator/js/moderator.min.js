"use strict";var mod=mod||{},DEBUG=!0,BASE_URL="/";window.onload=function(){if(!Handlebars||!$)return void console.log("missing dependencies for mod.utils.render_template");switch(null===localStorage.getItem("yellr-mod")?mod.utils.redirect_to_login("Missing authentication token. Please login to continue"):mod.utils.load_localStorage(),void 0===mod.DATA&&(mod.DATA={}),mod.PAGE=document.querySelector("body").getAttribute("data-page"),mod.PAGE){case"index":mod.setup.dashboard();break;case"login":mod.setup.login();break;case"assignments":mod.setup.assignments_page();break;case"single-assignment":mod.setup.single_assignment_view();break;case"editor":mod.editor.init();break;case"collections":mod.setup.collections_page();break;case"single-collection":mod.setup.single_collection_view();break;case"messages":mod.setup.inbox();break;default:console.log("lol ok")}document.querySelector("#sidebar")&&mod.utils.setup_sidebar()};var mod=mod||{};mod.setup={single_collection_view:function(){var a,b,c,d,e=[],f=0;f=parseInt(window.location.hash.split("#")[1]),mod.collections.get_collection(f,function(a){document.querySelector(".t1").innerHTML=a.collection_name,mod.utils.render_template({template:"#view-collection-gi-template",target:"#collection-wrapper",context:{collection:a.collection},append:!0}),e=document.querySelectorAll(".collection-gi"),setTimeout(function(){d=new Packery(c,{itemSelector:".collection-gi",columnWidth:".collection-grid-sizer",gutter:".gutter-sizer"})},500)}),c=document.querySelector("#collection-wrapper"),c.onclick=function(a){"fa fa-comment"===a.target.className?alert("Send message"):"fa fa-close"===a.target.className&&alert("Remove item from collection")},b=document.querySelector("#export-content-btn"),b.onclick=function(){alert("TODO: Download zip file of media collection")},a=document.querySelector(".collection-view-controls"),a.onclick=function(a){if(a.target.checked)if("list"===a.target.defaultValue){d.destroy();for(var b=0;b<e.length;b++)e[b].className="gi"}else{for(var b=0;b<e.length;b++)e[b].className="collection-gi";d=new Packery(c,{itemSelector:".collection-gi",columnWidth:".collection-grid-sizer",gutter:".gutter-sizer"})}}},login:function(){var a=$("#mod-login");a.submit(function(b){b.preventDefault();var c=a.serializeArray();mod.utils.login(c[0].value,c[1].value)})},assignments_page:function(){mod.assignments.get_my_assignments({callback:function(){console.log(mod.DATA.assignments);var a=mod.DATA.assignments.filter(function(a){return a.title=a.questions[0].question_text,a.expire_datetime=moment(a.expire_datetime).format("MMM Do YYYY"),a.url="view-assignment.html#"+a.assignment_id,!0});mod.utils.render_template({template:"#my-assignment-li",target:".my-assignments-list",context:{assignments:a}})}})},single_assignment_view:function(){var a=parseInt(window.location.hash.split("#")[1]);0/0!==a&&(mod.assignments.view(a),mod.assignments.get_responses_for({assignment_id:a,callback:function(a){var b=mod.utils.convert_object_to_array(a);mod.utils.render_template({template:"#assignment-response-li-template",target:"#assignment-replies-list",context:{replies:b}});var c=document.querySelector(".assignment-deadline");c.innerHTML=moment(c.innerHTML).format("MMMM Do YYYY");var d=document.querySelector(".assignment-published");d.innerHTML=moment(d.innerHTML).format("MMMM Do YYYY")}}),mod.collections.get_collection(a,function(a){mod.utils.render_template({template:"#collections-li-template",target:"#assignment-collection-list",context:{collection:a.collection}})}),document.querySelector("#assignment-collection-list").setAttribute("data-collection-id",a))},collections_page:function(){mod.collections.get_my_collections({callback:function(){var a=mod.DATA.collections.filter(function(a){return a.collection_datetime=moment(a.collection_datetime).format("MMM Do YYYY"),a.url="view-collection.html#"+a.collection_id,!0});mod.utils.render_template({template:"#collections-gi-template",target:".collections-grid",context:{collections:a}})}}),document.querySelector("#new-collection-btn").onclick=function(){mod.utils.show_overlay({template:"#collections-form-template"}),mod.collections.setup_form()},document.querySelector("#delete-collection-btn").onclick=function(){console.log("delete collection")}},inbox:function(){mod.messages.get_messages({feedback:!0,callback:function(){var a=mod.messages.filter_messages();mod.utils.render_template({template:"#inbox-li",target:"#unread-mail-list",context:{messages:a.unread}}),mod.utils.render_template({template:"#inbox-li",target:"#read-mail-list",context:{messages:a.read}})}}),document.querySelector("#inbox").onclick=function(a){var b="LI"===a.target.nodeName?a.target.getAttribute("data-id"):a.target.parentNode.getAttribute("data-id"),c=mod.DATA.messages.filter(function(a){return a.message_id===parseInt(b)?!0:void 0})[0];mod.utils.show_overlay({template:"#view-message-template",context:c})},document.querySelector("#new-message-btn").onclick=function(){mod.messages.create_new_message()}},dashboard:function(){mod.assignments.get_my_assignments({callback:function(){for(var a=[],b=0;b<mod.DATA.assignments.length&&(a.push(mod.DATA.assignments[b]),!(a.length>=4));b++);a.filter(function(a){a.expire_datetime=moment(a.expire_datetime).fromNow(!0)}),mod.utils.render_template({template:"#active-assignment-template",target:"#active-assignments-list",context:{assignments:a}})}}),mod.posts.get_posts({callback:function(){mod.utils.render_template({template:"#latest-posts-template",target:"#latest-posts",context:{posts:mod.DATA.posts}})}}),document.querySelector(".submissions-grid").onclick=function(a){switch(a.target.className){case"fa fa-folder":mod.feed.toggle_collections_dropdown(a.target);break;case"fa fa-comment":var b=a.target.offsetParent.querySelector(".meta-div"),c=parseInt(b.getAttribute("data-post-id")),d=mod.DATA.posts.filter(function(a){return a.post_id===c?!0:void 0})[0];mod.utils.show_overlay({template:"#send-message-template",context:{uid:d.client_id,subject:"RE: "+d.title}});var e=$("#send-message-form");e.submit(function(a){a.preventDefault();var b=e.serializeArray();mod.messages.send_message({to:b[0],subject:b[1],text:b[2],callback:function(){mod.utils.clear_overlay()}})});break;case"fa fa-flag":console.log("report the motherfucker")}},$("#refresh-posts").on("click",function(){mod.posts.get_posts({callback:function(){mod.utils.render_template({template:"#latest-posts-template",target:"#latest-posts",context:{posts:mod.DATA.posts}})}})})}};var mod=mod||{};mod.utils={convert_object_to_array:function(a){var b=[];for(var c in a)b.push(a[c]);return b},notify:function(a){console.log(a)},load_latest_posts:function(){setTimeout(function(){console.log("loading latest posts..."),mod.posts.get_posts({callback:function(){mod.utils.render_template({template:"#latest-posts-template",target:"#latest-posts",context:{posts:mod.DATA.posts}})}}),mod.utils.load_latest_posts()},1e4)},redirect_to:function(a){var b="/moderator/";window.location.replace(b+a)},redirect_to_login:function(a){"login"!==document.querySelector("body").getAttribute("data-page")&&(a&&alert(a),mod.utils.redirect_to("login.html"))},login:function(a,b){var c=BASE_URL+"admin/get_access_token.json?user_name="+a+"&password="+b;$.ajax({type:"POST",url:c,dataType:"json",success:function(a){a.success?(mod.TOKEN=a.token,mod.utils.save(),mod.utils.set_urls(),$.ajax({url:mod.URLS.get_languages,type:"POST",dataType:"json",success:function(a){a.success?(mod.DATA.languages=a.languages,mod.utils.save()):alert("Something went wrong loading Languages. Things might get weird from here...")}}).done(function(){console.log("done loading languages"),mod.utils.redirect_to("index.html")})):document.querySelector("#login-feedback").innerHTML=a.error_text}})},logout:function(){localStorage.removeItem("yellr-mod"),mod.utils.redirect_to_login("You have been logged out")},load_localStorage:function(){var a=JSON.parse(localStorage.getItem("yellr-mod"));mod.DATA=a.DATA,mod.SETTINGS=a.SETTINGS,mod.TOKEN=a.TOKEN,mod.URLS=a.URLS},load:function(a){void 0===mod.DATA&&(mod.DATA={}),$.getJSON(mod.URLS[a.data],function(b){if(b.success){if(a.saveAs){if(Array.isArray(b[a.saveAs])===!1){var c=[];for(var d in b.posts)c.push(b.posts[d]);mod.DATA[a.saveAs]=c}else mod.DATA[a.saveAs]=b[a.saveAs];"posts"===a.saveAs&&mod.DATA.posts.reverse(),mod.utils.save()}a.callback&&a.callback(b)}else console.log(b),console.log(mod.URLS[a.data]),console.log("Something went wrong loading: "+a.data+"\nThis could be because your previous session has expired. Please log back in")})},save:function(){localStorage.setItem("yellr-mod",JSON.stringify({DATA:mod.DATA,SETTINGS:mod.SETTINGS,TOKEN:mod.TOKEN,URLS:mod.URLS}))},set_urls:function(){var a=BASE_URL+"admin/";mod.URLS={get_posts:a+"get_posts.json?token="+mod.TOKEN,get_my_messages:a+"get_my_messages.json?token="+mod.TOKEN,create_message:a+"create_message.json?token="+mod.TOKEN,create_question:a+"create_question.json?token="+mod.TOKEN,get_my_assignments:a+"get_my_assignments.json?token="+mod.TOKEN,publish_assignment:a+"publish_assignment.json?token="+mod.TOKEN,update_assignment:a+"update_assignment.json?token="+mod.TOKEN,get_assignment_responses:a+"get_assignment_responses.json?token="+mod.TOKEN,create_collection:a+"create_collection.json?token="+mod.TOKEN,get_my_collections:a+"get_my_collections.json?token="+mod.TOKEN,disable_collection:a+"disable_collection.json?token="+mod.TOKEN,add_post_to_collection:a+"add_post_to_collection.json?token="+mod.TOKEN,remove_post_from_collection:a+"remove_post_from_collection.json?token="+mod.TOKEN,get_collection_posts:a+"get_collection_posts.json?token="+mod.TOKEN,get_languages:a+"get_languages.json?token="+mod.TOKEN,get_question_types:a+"get_question_types.json?token="+mod.TOKEN,create_user:a+"create_user.json?token="+mod.TOKEN,publish_story:a+"publish_story.json?token="+mod.TOKEN,upload:BASE_URL+"upload_media.json"},mod.utils.save()},show_overlay:function(a){var b=document.querySelector("#overlay-div-container");b.className="active",b.onclick=mod.utils.clear_overlay,a&&this.render_template({template:a.template,context:a.context,target:b})},clear_overlay:function(a){if(void 0===a||"overlay-div-container"===a.target.id){var b=document.querySelector("#overlay-div-container");return b.className="",void b.removeEventListener("click",mod.utils.clear_overlay,!1)}},render_template:function(a){if(!a.template||""===a.template)return void $(a.target).html("");var b=Handlebars.compile($(a.template).html()),c=b(a.context?a.context:{});a.append?$(a.target).append(c):a.prepend?$(a.target).prepend(c):$(a.target).html(c)},setup_sidebar:function(){document.querySelector("#post-question-btn").onclick=mod.assignments.setup_form,document.querySelector("#logout-btn").onclick=mod.utils.logout}};var mod=mod||{};mod.assignments=function(){var a,b,c,d,e,f,g,h,i,j,k=function(a){$.getJSON(mod.URLS.get_my_assignments,function(a){a.success?(mod.DATA.assignments=mod.utils.convert_object_to_array(a.assignments),mod.utils.save()):console.log("something went wrong loading get_my_assignments")}).done(function(){a.callback&&a.callback()}).fail(function(){mod.utils.redirect_to_login()})},l=[],m=[],n=[],o=function(a){$.ajax({url:mod.URLS.get_assignment_responses+"&assignment_id="+a.assignment_id,type:"POST",dataType:"json",success:function(b){b.success?a.callback&&a.callback(b.posts):console.log("lol Something went wrong loading assignment reponses")}}).done(function(){$("#assignment-replies-list").on("click",function(a){switch(a.target.className){case"fa fa-plus":var b=a.target.parentNode.parentNode.parentNode.querySelector(".meta-div"),c=document.querySelector("#assignment-collection-list");mod.collections.add_post_to_collection(b,c);break;case"fa fa-comment":console.log("write a message");var d=a.target.offsetParent.querySelector(".meta-div").getAttribute("data-uid");mod.messages.create_message(d,"RE: Recent post on Yellr");break;case"fa fa-flag":console.log("mark as ain appropriate");break;case"fa fa-trash":console.log("discard this reply")}})}).fail(function(){mod.utils.redirect_to_login()})},p=function(a){var b=mod.DATA.assignments.filter(function(b){return b.assignment_id===a?!0:void 0})[0];mod.utils.render_template({template:"#assignment-overview-template",target:"#view-assignment-section",context:{assignment:b}})},q=function(){mod.utils.show_overlay({template:"#new-assignment-template"}),a=$("#assignment-form-wrapper"),c=a.find("#questions-container"),f=a.find("#extra-assignment-fields"),h=a.find("#cancel-assignment-btn"),g=a.find("#preview-assignment-btn"),i=a.find("#save-assignment-btn"),j=a.find("#post-assignment-btn"),b=$("#question-text-preview"),a.find(".form-fields-list").hide(),f.hide(),g.hide(),i.hide(),j.hide(),h.on("click",function(){mod.utils.clear_overlay()}),a.find("#language-select").on("change",function(){"--"!==this.value&&mod.assignments.create_question_form(this.value)}),i.on("click",function(){mod.assignments.save_draft()}),g.on("click",function(){console.log("preview assignment"),mod.assignments.preview_assignment()})},r=function(g){f.hide(),b.removeClass("active"),mod.utils.render_template({template:"#new-question-template",target:c,context:{language:g}}),d=a.find("#"+g+"-question-form"),d.find(".answers-input-wrapper").hide(),d.find('input[type="radio"]').on("change",function(){"multiple_choice"===this.value?d.find(".answers-input-wrapper").show():d.find(".answers-input-wrapper").hide()}),d.find(".question-answer-input").keypress(function(a){13===a.which&&(a.preventDefault(),m.push(d.find(".question-answer-input").val()),mod.utils.render_template({template:"#new-survey-answer-template",target:"#survey-answers-list",context:{answer:d.find(".question-answer-input").val()},append:!0}),d.find(".question-answer-input").val(""),console.log(m))}),e=d.find("#question_textarea"),e.on("keyup",function(){b.html(e.val()),""===e.val()&&b.html("Ask the community...")}),b.html("Ask the community..."),j.show(),j.html("Add Question"),j.off("click"),j.on("click",function(){$.ajax({type:"POST",url:mod.URLS.create_question,data:d.serialize()+"&answers="+JSON.stringify(m),dataType:"json",success:function(a){a.success?(console.log("SUCCESS"),n.push(g),mod.assignments.successful_question_post(a)):(console.log("FAIL"),console.log(a))}})})},s=function(c){l.push(c.question_id),b.html(e.val()),b.addClass("active"),d.hide(),a.find(".language-select-wrapper").hide(),i.show(),g.show(),j.html("Post Assignment"),j.off("click"),j.on("click",function(){mod.assignments.post()}),f.show(),this.language_feedback()},t=function(){var a=mod.DATA.languages.filter(function(a){for(var b=0;b<n.length;b++)if(a.code===n[b])return!0});mod.utils.render_template({target:"#supported-languages",template:"#language-support-template",context:{languages:a}}),$("#language-select").find('option[value="'+n[n.length-1]+'"]').remove(),$("#add-language-btn").on("click",function(){$("#assignment-form-wrapper .language-select-wrapper").show()})},u=function(){console.log("do some css things to hide this and show that")},v=function(){alert("save draft. NOT IMPLEMENTED. THIS DOES NOTHING LOL")},w=function(){var b=a.find("#lifetime").val(),c=a.find("#unit-of-time-list input:checked").val(),d="days"===c?24:720,e=b*d;$.ajax({type:"POST",url:mod.URLS.publish_assignment,data:{life_time:e,questions:JSON.stringify(l),top_left_lat:43.4,top_left_lng:-77.9,bottom_right_lat:43,bottom_right_lng:-77.3},dataType:"json",success:function(a){a.success?$.ajax({url:mod.URLS.create_collection,type:"POST",dataType:"json",data:{name:"Assignment #"+a.assignment_id+" Collection",description:"Collection for #"+a.assignment_id,tags:"some, example, collection tags"},success:function(a){a.success?(l=[],mod.utils.clear_overlay()):console.log("something went wrong creating a collection for this assignment")}}).done(function(){mod.assignments.get_my_assignments({callback:function(){mod.utils.redirect_to("view-assignment.html#"+a.assignment_id)}})}):alert("Something went wrong submitting an Assignment")}})};return{view:p,setup_form:q,create_question_form:r,successful_question_post:s,post:w,save_draft:v,preview_assignment:u,language_feedback:t,get_my_assignments:k,get_responses_for:o}}();var mod=mod||{};mod.collections={get_collection:function(a,b){var c="",d=[],e=!1;$.getJSON(mod.URLS.get_collection_posts,{collection_id:a},function(a){a.success&&(e=!0,d=mod.utils.convert_object_to_array(a.posts),c=a.collection_name)}).done(function(){e?b&&b({collection:d,collection_name:c}):console.log("something went wrong loading collection posts")}).fail(function(){mod.utils.redirect_to_login()})},get_my_collections:function(a){$.getJSON(mod.URLS.get_my_collections,function(a){a.success?(mod.DATA.collections=a.collections,mod.utils.save()):console.log("something went wrong getting your collections")}).done(function(){a.callback&&a.callback()}).fail(function(){mod.utils.redirect_to_login()})},add_post_to_collection:function(a,b,c){var d=!1;$.post(mod.URLS.add_post_to_collection,{post_id:a,collection_id:b},function(a){a.success&&(d=!0)}).done(function(){console.log(d?"added post to collection":"something went wrong adding the post to the collection"),c&&c(d)}).fail(function(){return console.log("something went wrong adding the post to the collection"),d})},setup_form:function(){console.log("hello from: setup_form"),$("#new-collections-form").find(".submit-btn").on("click",function(){console.log("submit the form"),mod.collections.submit_form()})},submit_form:function(){console.log("hello from: submit_form"),console.log("url: "+mod.URLS.create_collection),$.ajax({url:mod.URLS.create_collection,type:"POST",dataType:"json",data:$("#new-collections-form").serialize(),success:function(a){a.success?(console.log("SUCCESS"),console.log(a),mod.utils.clear_overlay()):console.log("something went wrong")}})}};var mod=mod||{};mod.editor=function(){var a=function(){function a(a,b){this.update=function(){var c="# "+$("#article-title").val()+"\n";b.innerHTML=markdown.toHTML(c+a.value)},a.editor=this,this.update()}mod.collections.get_collection(parseInt(window.location.hash.split("#")[1]),function(a){mod.utils.render_template({template:"#collections-li-template",target:"#editor-collections-list",context:{collection:a.collection}})});var b=new a(document.getElementById("markdown-editor"),document.getElementById("editor-preview"));$("#preview-btn").on("click",function(){var a=$("#editor-workspace .editor-container"),c=a.find(".active"),d=a.find(".inactive");c.removeClass("active").addClass("inactive"),d.removeClass("inactive").addClass("active"),b.update()}),$("#editor-controls .submit-btn").on("click",function(){$.post(mod.URLS.publish_story,{title:$("#article-title").val(),tags:"test, 1, 2, 3",top_text:$("#top-text").val(),banner_media_id:"",contents:$("#markdown-editor").val(),language_code:"en",top_left_lat:43.4,top_left_lng:-77.9,bottom_right_lat:43,bottom_right_lng:-77.3},function(a){console.log(a.success?"post successful!":"something went wrong"),console.log(a)})})};return{init:a}}();var mod=mod||{};mod.feed={toggle_collections_dropdown:function(a){$(a.parentNode).hasClass("dropdown-container")?mod.feed.hide_collections_dropdown(a):mod.feed.show_collections_dropdown(a)},show_collections_dropdown:function(a){$(a.parentNode).addClass("dropdown-container"),mod.utils.render_template({template:"#collections-dropdown-template",target:a.parentNode,context:{collections:mod.DATA.collections},append:!0}),$(a.parentNode).find(".collections-dropdown").on("click",function(a){mod.feed.add_post_to_collection_from_feed(a.target)})},hide_collections_dropdown:function(a){$(a.parentNode).removeClass("dropdown-container"),mod.utils.render_template({template:"",target:$(a.parentNode).find(".collections-dropdown")})},add_post_to_collection_from_feed:function(a){var b=$(a.offsetParent.offsetParent.parentNode.parentNode.parentNode),c=b.find(".meta-div").data("post-id"),d=$(a).data("collection-id");mod.collections.add_post_to_collection(c,d,function(b){b&&(a.parentNode.style.opacity="0.3")})}},moderator.filter={settings:{source_type:"all",media_types:["video","photo","audio","text"],text:""},init:function(a){moderator.submissions_grid=a.grid.querySelectorAll(".story-item");var b=document.querySelector(".filter-form");b.querySelector("#filter-submission-type").onclick=this.submission_type,b.querySelector("#filter-content-type").onclick=this.content_type,b.querySelector("#filter-search").onkeyup=this.search},submission_type:function(a){"INPUT"==a.target.tagName&&(moderator.filter.settings.source_type=a.target.value,moderator.filter.grid({array:moderator.submissions_grid,settings:moderator.filter.settings}))},content_type:function(a){if("INPUT"==a.target.tagName){for(var b=[],c=a.target.parentNode.parentNode,d=c.querySelectorAll('input[type="checkbox"]'),e=0;e<d.length;e++){var f=d[e];f.checked&&b.push(f.value)}moderator.filter.settings.media_types=b,moderator.filter.grid({array:moderator.submissions_grid,settings:moderator.filter.settings})}},search:function(a){moderator.filter.settings.text=a.target.value.toLowerCase(),moderator.filter.grid({array:moderator.submissions_grid,settings:moderator.filter.settings})},grid:function(a){for(var b=0;b<a.array.length;b++){var c=a.array[b],d=c.querySelector(".meta-div"),e=c.className;c.className=e.split("filtered-out")[0],"all"!==a.settings.source_type&&d.getAttribute("data-source")!==a.settings.source_type&&(c.className+=" filtered-out");for(var f=d.getAttribute("data-type"),g=!1,h=0;h<a.settings.media_types.length;h++){var i=a.settings.media_types[h];if(f==i){g=!0;break}}g||(c.className+=" filtered-out");var j=new RegExp(moderator.filter.settings.text),k=c.querySelector(".description").innerHTML.toLowerCase();k.search(j)&&(c.className+=" filtered-out")}moderator.packery.reloadItems();for(var l=document.querySelectorAll(".filtered-out"),h=0;h<l.length;h++)moderator.packery.remove(l[h].parentNode);moderator.packery.layout()}};var mod=mod||{};mod.messages={get_messages:function(a){$.getJSON(mod.URLS.get_my_messages,function(a){a.success?mod.DATA.messages=a.messages:mod.utils.notify("Could not load new messages.")}).done(function(){a.callback&&a.callback()}).fail(function(){mod.utils.redirect_to_login()})},filter_messages:function(){var a=[],b=mod.DATA.messages.filter(function(b,c,d){return b.message_datetime=moment(b.message_datetime).format("MMM Do, h:mm a"),0===parseInt(b.was_read)?!0:void a.push(d[c])});return{read:a,unread:b}},init:function(a){self=this,template=Handlebars.compile($(a.template).html()),container=a.container,read_target=a.read_target,unread_target=a.unread_target,$.getJSON(a.data_url,function(a){raw_data=a.messages,self.render()})},render:function(){var a=template({messages:raw_data});$(unread_target).html(a),$(read_target).html(a)},send_message:function(a){var b={subject:a.subject.value,text:a.text.value,to_client_id:a.to.value};a.parent_message_id&&(b.parent_message_id=a.parent_message_id),$.ajax({type:"POST",url:mod.URLS.create_message,dataType:"json",data:b,success:function(a){mod.utils.notify(a.success?"Message sent!":"Error sending message. Check the user ID.")}}).done(function(){a.callback&&a.callback()})}};var mod=mod||{};mod.posts={get_posts:function(a){$.getJSON(mod.URLS.get_posts,function(a){a.success?(mod.DATA.posts=mod.utils.convert_object_to_array(a.posts).reverse(),mod.utils.save()):mod.utils.notify("Something went wrong loading posts.")}).done(function(){a.callback&&a.callback()}).fail(function(){mod.utils.redirect_to_login()})}};